{% extends 'admin_base.html' %}

{% block title %}Manage Bundle Offers{% endblock %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">
<style>
  .dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    transform: translateY(-1px);
  }
  
  .table-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .search-filter-card {
    background: white;  
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .badge-active {
    background-color: #28a745;
  }
  
  .badge-inactive {
    background-color: #6c757d;
  }
  
  .action-buttons .btn {
    margin: 0 2px;
    padding: 0.25rem 0.5rem;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
  }
  
  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h2 mb-1">Manage Bundle Offers</h1>
        <p class="mb-0 opacity-75">Create and manage book bundle deals</p>
      </div>
      <a href="{{ url_for('admin.add_bundle') }}" class="btn btn-light btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Add New Bundle
      </a>
    </div>
  </div>
</div>

<div class="container">
  <!-- Search and Filter Card -->
  <div class="search-filter-card">
    <form method="GET" class="row g-3">
      <div class="col-md-4">
        <label for="search" class="form-label">Search Bundles</label>
        <input type="text" class="form-control" id="search" name="search" 
               value="{{ search }}" placeholder="Search by bundle title...">
      </div>
      <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status">
          <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Bundles</option>
          <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active Only</option>
          <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive Only</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="sort" class="form-label">Sort By</label>
        <select class="form-select" id="sort" name="sort">
          <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title (A-Z)</option>
          <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Price</option>
          <option value="created" {% if sort_by == 'created' %}selected{% endif %}>Created Date</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-1"></i>Apply
        </button>
      </div>
    </form>
  </div>

  <!-- Bundles Table -->
  <div class="table-container">
    {% if bundles %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th>Bundle Title</th>
            <th>Books Count</th>
            <th>MRP</th>
            <th>Selling Price</th>
            <th>Discount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for bundle in bundles %}
          <tr>
            <td>
              <div>
                <strong>{{ bundle.title[:50] }}{% if bundle.title|length > 50 %}...{% endif %}</strong>
                {% if bundle.description %}
                <br><small class="text-muted">{{ bundle.description[:80] }}{% if bundle.description|length > 80 %}...{% endif %}</small>
                {% endif %}
              </div>
            </td>
            <td>
              <span class="badge bg-info">{{ bundle.books|length }} books</span>
            </td>
            <td>₹{{ "%.2f"|format(bundle.mrp) }}</td>
            <td>
              <strong class="text-success">₹{{ "%.2f"|format(bundle.selling_price) }}</strong>
            </td>
            <td>
              {% if bundle.discount_type == 'percentage' %}
                <span class="badge bg-warning">{{ "%.1f"|format(bundle.discount_value) }}%</span>
              {% else %}
                <span class="badge bg-warning">₹{{ "%.2f"|format(bundle.discount_value) }}</span>
              {% endif %}
            </td>
            <td>
              {% if bundle.is_active %}
                <span class="badge badge-active">Active</span>
              {% else %}
                <span class="badge badge-inactive">Inactive</span>
              {% endif %}
            </td>
            <td>
              <div class="action-buttons">
                <a href="{{ url_for('admin.edit_bundle', bundle_id=bundle.id) }}" 
                   class="btn btn-sm btn-outline-primary" title="Edit Bundle">
                  <i class="bi bi-pencil"></i>
                </a>
                <button class="btn btn-sm btn-outline-danger" 
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteModal{{ bundle.id }}" 
                        title="Delete Bundle">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
      <i class="bi bi-collection"></i>
      <h4>No Bundle Offers Found</h4>
      <p>{% if search or status_filter != 'all' %}
        No bundles match your current filters. Try adjusting your search criteria.
      {% else %}
        You haven't created any bundle offers yet. Create your first bundle to get started!
      {% endif %}</p>
      <a href="{{ url_for('admin.add_bundle') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Create First Bundle
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Delete Confirmation Modals -->
{% for bundle in bundles %}
<div class="modal fade" id="deleteModal{{ bundle.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ bundle.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel{{ bundle.id }}">Delete Bundle Offer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the bundle offer <strong>"{{ bundle.title }}"</strong>?</p>
        <p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i>This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('admin.delete_bundle', bundle_id=bundle.id) }}" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete Bundle</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// Form submission handling
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form on status/sort change
    document.getElementById('status').addEventListener('change', function() {
        this.form.submit();
    });
    
    document.getElementById('sort').addEventListener('change', function() {
        this.form.submit();
    });
});
</script>
{% endblock %}