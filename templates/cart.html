{% extends 'base_new.html' %}
{% block title %}Your Cart{% endblock %}

{% block extra_css %}
<style>
/* Fix navigation responsiveness */
@media (max-width: 1199px) {
  .master-search-container {
    max-width: 400px;
  }
  
  .search-category-dropdown {
    min-width: 80px;
    font-size: 13px;
  }
}

@media (max-width: 991px) {
  .navbar-nav {
    text-align: center;
  }
  
  .nav-item {
    margin: 5px 0;
  }
}

/* Fix navbar overflow issues */
.navbar {
  overflow: visible;
}

.navbar-brand {
  flex-shrink: 0;
}

.master-search-container {
  flex: 1;
  min-width: 0;
}

/* Ensure proper container behavior */
.container-fluid {
  width: 100%;
  padding-right: var(--bs-gutter-x, 0.75rem);
  padding-left: var(--bs-gutter-x, 0.75rem);
  margin-right: auto;
  margin-left: auto;
}

/* Bundle-specific styling */
.bundle-item {
  background-color: rgba(255, 193, 7, 0.05);
  border-left: 3px solid #ffc107;
}

.bundle-card {
  border-left: 3px solid #ffc107 !important;
  background-color: rgba(255, 193, 7, 0.02);
}

.bundle-preview img {
  border: 1px solid #dee2e6;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.bundle-book-title {
  display: block;
  font-size: 10px;
  color: #333;
  max-width: 60px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-top: 2px;
}

.bundle-item .collapse .card-body {
  background-color: rgba(248, 249, 250, 0.8);
  border-radius: 0.375rem;
}

.bundle-card .collapse {
  background-color: rgba(248, 249, 250, 0.5);
  border-radius: 0.375rem;
}

/* Fix navbar collapse on smaller screens */
@media (max-width: 1199px) {
  .navbar-nav {
    flex-wrap: wrap;
  }
  
  .nav-item {
    flex-shrink: 0;
  }
}

/* Improve search bar responsiveness */
@media (max-width: 1399px) {
  .master-search-input {
    min-width: 200px;
  }
}

@media (max-width: 1199px) {
  .master-search-input {
    min-width: 150px;
  }
}

/* Responsive table improvements */
.table-responsive {
  border-radius: 8px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Mobile cart improvements */
@media (max-width: 767px) {
  .btn-lg {
    padding: 12px 20px;
    font-size: 16px;
  }
  
  .container-fluid {
    padding-left: 10px;
    padding-right: 10px;
  }
  
  .card-body {
    padding: 15px;
  }
  
  h2 {
    font-size: 1.5rem;
  }
}

/* Tablet improvements */
@media (min-width: 768px) and (max-width: 991px) {
  .master-search-container {
    max-width: 300px;
  }
  
  .navbar-nav .nav-link {
    padding: 8px 12px;
    font-size: 14px;
  }
}

/* Prevent horizontal scroll */
body {
  overflow-x: hidden;
}

.row {
  margin-left: 0;
  margin-right: 0;
}

.col-12 {
  padding-left: 0;
  padding-right: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4 py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <h2 class="text-center mb-4 fw-bold text-dark">Your Shopping Cart</h2>

      {% if cart and cart|length > 0 %}
      
      <!-- Desktop View -->
      <div class="d-none d-lg-block">
        <div class="card border-0 shadow-sm">
          <div class="table-responsive">
            <table class="table table-hover mb-0" style="min-width: 800px;">
              <thead class="table-primary">
                <tr>
                  <th class="py-3" style="width: 35%;">Product</th>
                  <th class="py-3" style="width: 15%;">Details</th>
                  <th class="py-3" style="width: 12%;">Price</th>
                  <th class="py-3" style="width: 8%;">Qty</th>
                  <th class="py-3" style="width: 12%;">Total</th>
                  <th class="py-3 text-center" style="width: 10%;">Action</th>
                </tr>
              </thead>
              <tbody>
                {% set grand_total = namespace(value=0) %}
                {% for item in cart %}
                  {% set item_total = item.price * item.quantity %}
                  {% set grand_total.value = grand_total.value + item_total %}
                  
                  {% if item.get('type') == 'bundle' %}
                    <!-- Bundle Item Row -->
                    <tr class="bundle-item">
                      <td class="py-3">
                        <div class="d-flex align-items-center">
                          <div class="bundle-preview me-3">
                            {% if item.books %}
                              <div class="d-flex flex-wrap" style="width: 50px;">
                                {% for book in item.books[:4] %}
                                  {% if book.image %}
                                    <div class="position-relative">
                                      <img src="{{ url_for('static', filename='uploads/books/' ~ book.image) }}" 
                                           alt="{{ book.title }}" 
                                           class="rounded mb-1 me-1"
                                           style="width: 20px; height: 25px; object-fit: contain;">
                                      <span class="bundle-book-title d-none d-md-block position-absolute" style="font-size: 8px;">{{ book.title|truncate(10) }}</span>
                                    </div>
                                  {% endif %}
                                {% endfor %}
                              </div>
                            {% else %}
                              <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                   style="width: 50px; height: 65px;">
                                <i class="bi bi-collection text-muted"></i>
                              </div>
                            {% endif %}
                          </div>
                          <div class="flex-grow-1 min-width-0">
                            <h6 class="mb-1 fw-semibold text-truncate">{{ item.title }}</h6>
                            <small class="text-muted">
                              Bundle ({{ item.books|length }} books)
                              <button class="btn btn-link btn-sm p-0 ms-2" type="button" 
                                      data-bs-toggle="collapse" 
                                      data-bs-target="#bundle-{{ item.id }}" 
                                      aria-expanded="false">
                                <i class="bi bi-chevron-down"></i> View Books
                              </button>
                            </small>
                          </div>
                        </div>
                      </td>
                      <td class="py-3">
                        <span class="badge bg-warning text-dark mb-1">Bundle</span><br>
                        <small class="text-muted">{{ item.books|length }} books included</small>
                      </td>
                      <td class="py-3">
                        <span class="fw-bold text-success">₹{{ "%.2f"|format(item.price) }}</span>
                        <br><small class="text-muted">Bundle Price</small>
                      </td>
                      <td class="py-3">
                        <span class="badge bg-light text-dark">
                          <i class="bi bi-collection me-1"></i>{{ item.quantity }}
                        </span>
                      </td>
                      <td class="py-3">
                        <span class="fw-bold">₹{{ "%.2f"|format(item_total) }}</span>
                      </td>
                      <td class="py-3 text-center">
                        <a href="{{ url_for('remove_from_cart_generic', item_type='bundle', item_id=item.id) }}" 
                           class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                    <!-- Expandable Bundle Books -->
                    <tr>
                      <td colspan="6" class="p-0">
                        <div class="collapse" id="bundle-{{ item.id }}">
                          <div class="bg-light border-top">
                            <div class="p-3">
                              <h6 class="mb-3 text-primary"><i class="bi bi-collection me-2"></i>Books in this Bundle</h6>
                              <div class="row g-3">
                                {% for book in item.books %}
                                  <div class="col-lg-6 col-xl-4">
                                    <div class="card h-100 border-0 shadow-sm">
                                      <div class="card-body p-3">
                                        <div class="d-flex align-items-start">
                                          {% if book.image %}
                                            <img src="{{ url_for('static', filename='uploads/books/' ~ book.image) }}" 
                                                 alt="{{ book.title }}" 
                                                 class="rounded me-3 flex-shrink-0"
                                                 style="width: 45px; height: 60px; object-fit: contain;">
                                          {% else %}
                                            <div class="bg-primary bg-opacity-10 rounded me-3 d-flex align-items-center justify-content-center flex-shrink-0" 
                                                 style="width: 45px; height: 60px;">
                                              <i class="bi bi-book text-primary"></i>
                                            </div>
                                          {% endif %}
                                          <div class="flex-grow-1 min-width-0">
                                            <h6 class="mb-1 fw-semibold text-truncate" style="font-size: 0.9rem;">{{ book.title }}</h6>
                                            <p class="mb-1 text-muted small">by {{ book.author }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                              <span class="fw-bold text-success">₹{{ "%.2f"|format(book.price) }}</span>
                                              {% if book.categories %}
                                                <span class="badge bg-primary bg-opacity-10 text-primary small">{{ book.categories[0].name }}</span>
                                              {% endif %}
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                {% endfor %}
                              </div>
                              <div class="mt-3 pt-2 border-top">
                                <div class="row align-items-center">
                                  <div class="col-sm-6">
                                    <small class="text-muted">
                                      <i class="bi bi-info-circle me-1"></i>
                                      Total {{ item.books|length }} books • Individual price: ₹{{ "%.2f"|format(item.books|sum(attribute='price')) }}
                                    </small>
                                  </div>
                                  <div class="col-sm-6 text-sm-end mt-2 mt-sm-0">
                                    <span class="badge bg-success">
                                      <i class="bi bi-tag me-1"></i>
                                      Bundle Savings: ₹{{ "%.2f"|format((item.books|sum(attribute='price')) - item.price) }}
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  {% elif item.get('type') == 'course' %}
                    <!-- Course Item Row -->
                    <tr>
                      <td class="py-3">
                        <div class="d-flex align-items-center">
                          {% if item.image %}
                            <img src="{{ url_for('static', filename='uploads/courses/' ~ item.image) }}" 
                                 alt="{{ item.title }}" 
                                 class="rounded me-3 flex-shrink-0"
                                 style="width: 50px; height: 65px; object-fit: contain;">
                          {% else %}
                            <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center flex-shrink-0" 
                                 style="width: 50px; height: 65px;">
                              <i class="bi bi-play-circle text-muted"></i>
                            </div>
                          {% endif %}
                          <div class="flex-grow-1 min-width-0">
                            <h6 class="mb-1 fw-semibold text-truncate">{{ item.title }}</h6>
                            <small class="text-muted text-truncate d-block">Certificate Course</small>
                          </div>
                        </div>
                      </td>
                      <td class="py-3">
                        <div>
                          <span class="badge bg-success mb-1">Course</span><br>
                          <small class="text-muted">Online Learning</small>
                        </div>
                      </td>
                      <td class="py-3">
                        <span class="fw-bold text-success">₹{{ "%.2f"|format(item.price) }}</span>
                      </td>
                      <td class="py-3">
                        <span class="badge bg-light text-dark">{{ item.quantity }}</span>
                      </td>
                      <td class="py-3">
                        <span class="fw-bold">₹{{ "%.2f"|format(item_total) }}</span>
                      </td>
                      <td class="py-3 text-center">
                        <a href="{{ url_for('remove_from_cart_generic', item_type='course', item_id=item.id) }}" 
                           class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                  {% else %}
                    <!-- Regular Book Item Row -->
                    <tr>
                      <td class="py-3">
                        <div class="d-flex align-items-center">
                          {% if item.image %}
                            <img src="{{ url_for('static', filename='uploads/books/' ~ item.image) }}" 
                                 alt="{{ item.title }}" 
                                 class="rounded me-3 flex-shrink-0"
                                 style="width: 50px; height: 65px; object-fit: contain;">
                          {% else %}
                            <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center flex-shrink-0" 
                                 style="width: 50px; height: 65px;">
                              <i class="bi bi-book text-muted"></i>
                            </div>
                          {% endif %}
                          <div class="flex-grow-1 min-width-0">
                            <h6 class="mb-1 fw-semibold text-truncate">{{ item.title }}</h6>
                            <small class="text-muted text-truncate d-block">by {{ item.author }}</small>
                          </div>
                        </div>
                      </td>
                      <td class="py-3">
                        <div>
                          <span class="badge bg-primary mb-1">{{ item.category }}</span><br>
                          <small class="text-muted">{{ item.subject }}</small>
                        </div>
                      </td>
                      <td class="py-3">
                        <span class="fw-bold text-success">₹{{ "%.2f"|format(item.price) }}</span>
                      </td>
                      <td class="py-3">
                        <span class="badge bg-light text-dark">{{ item.quantity }}</span>
                      </td>
                      <td class="py-3">
                        <span class="fw-bold">₹{{ "%.2f"|format(item_total) }}</span>
                      </td>
                      <td class="py-3 text-center">
                        <a href="{{ url_for('remove_from_cart_generic', item_type='book', item_id=item.id) }}" 
                           class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="table-light">
                  <td colspan="4" class="py-3 text-end fw-bold">Grand Total:</td>
                  <td class="py-3 fw-bold text-success fs-5">₹{{ "%.2f"|format(grand_total.value) }}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Mobile View -->
      <div class="d-lg-none">
        {% set grand_total = namespace(value=0) %}
        {% for item in cart %}
          {% set item_total = item.price * item.quantity %}
          {% set grand_total.value = grand_total.value + item_total %}
          
          {% if item.get('type') == 'bundle' %}
            <!-- Mobile Bundle Card -->
            <div class="card mb-3 border-0 shadow-sm bundle-card">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3">
                    {% if item.books %}
                      <div class="position-relative">
                        <div class="d-flex flex-wrap" style="height: 80px;">
                          {% for book in item.books[:4] %}
                            {% if book.image %}
                              <img src="{{ url_for('static', filename='uploads/books/' ~ book.image) }}" 
                                   alt="{{ book.title }}" 
                                   class="rounded me-1 mb-1"
                                   style="width: 35px; height: 45px; object-fit: contain;">
                            {% endif %}
                          {% endfor %}
                        </div>
                        {% if item.books|length > 4 %}
                          <small class="position-absolute bottom-0 end-0 badge bg-dark">+{{ item.books|length - 4 }}</small>
                        {% endif %}
                      </div>
                    {% else %}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                           style="height: 80px;">
                        <i class="bi bi-collection text-muted"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-9">
                    <h6 class="mb-1 fw-semibold">{{ item.title }}</h6>
                    <p class="mb-1 text-muted small">Bundle ({{ item.books|length }} books)</p>
                    <div class="mb-2">
                      <span class="badge bg-warning text-dark me-1">Bundle</span>
                      <button class="btn btn-link btn-sm p-0" type="button" 
                              data-bs-toggle="collapse" 
                              data-bs-target="#bundle-mobile-{{ item.id }}" 
                              aria-expanded="false">
                        <small><i class="bi bi-chevron-down"></i> View Books</small>
                      </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <span class="fw-bold text-success">₹{{ "%.2f"|format(item.price) }}</span>
                        <span class="text-muted"> × {{ item.quantity }}</span>
                      </div>
                      <div>
                        <span class="fw-bold me-2">₹{{ "%.2f"|format(item_total) }}</span>
                        <a href="{{ url_for('remove_from_cart_generic', item_type='bundle', item_id=item.id) }}" 
                           class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-trash"></i>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Expandable Book List -->
                <div class="collapse mt-3" id="bundle-mobile-{{ item.id }}">
                  <div class="border-top pt-3">
                    <h6 class="small fw-semibold mb-3 text-primary">
                      <i class="bi bi-collection me-1"></i>Books in this Bundle
                    </h6>
                    <div class="row g-2">
                      {% for book in item.books %}
                        <div class="col-12">
                          <div class="card border-0 bg-white shadow-sm">
                            <div class="card-body p-2">
                              <div class="d-flex align-items-center">
                                {% if book.image %}
                                  <img src="{{ url_for('static', filename='uploads/books/' ~ book.image) }}" 
                                       alt="{{ book.title }}" 
                                       class="rounded me-3 flex-shrink-0"
                                       style="width: 35px; height: 45px; object-fit: contain;">
                                {% else %}
                                  <div class="bg-primary bg-opacity-10 rounded me-3 d-flex align-items-center justify-content-center flex-shrink-0" 
                                       style="width: 35px; height: 45px;">
                                    <i class="bi bi-book text-primary small"></i>
                                  </div>
                                {% endif %}
                                <div class="flex-grow-1 min-width-0">
                                  <h6 class="mb-1 fw-semibold text-truncate" style="font-size: 0.85rem;">{{ book.title }}</h6>
                                  <p class="mb-1 text-muted small">by {{ book.author }}</p>
                                  <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-success small">₹{{ "%.2f"|format(book.price) }}</span>
                                    {% if book.categories %}
                                      <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 0.7rem;">{{ book.categories[0].name }}</span>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="mt-3 pt-2 border-top">
                      <div class="d-flex flex-column gap-2">
                        <small class="text-muted">
                          <i class="bi bi-info-circle me-1"></i>
                          {{ item.books|length }} books • Individual total: ₹{{ "%.2f"|format(item.books|sum(attribute='price')) }}
                        </small>
                        <span class="badge bg-success align-self-start">
                          <i class="bi bi-tag me-1"></i>
                          You save: ₹{{ "%.2f"|format((item.books|sum(attribute='price')) - item.price) }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% elif item.get('type') == 'course' %}
            <!-- Mobile Course Card -->
            <div class="card mb-3 border-0 shadow-sm">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3">
                    {% if item.image %}
                      <img src="{{ url_for('static', filename='uploads/courses/' ~ item.image) }}" 
                           alt="{{ item.title }}" 
                           class="img-fluid rounded"
                           style="height: 80px; object-fit: contain;">
                    {% else %}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                           style="height: 80px;">
                        <i class="bi bi-play-circle text-muted"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-9">
                    <h6 class="mb-1 fw-semibold">{{ item.title }}</h6>
                    <p class="mb-1 text-muted small">Certificate Course</p>
                    <div class="mb-2">
                      <span class="badge bg-success me-1">Course</span>
                      <span class="badge bg-secondary">Online Learning</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <span class="fw-bold text-success">₹{{ "%.2f"|format(item.price) }}</span>
                        <span class="text-muted"> × {{ item.quantity }}</span>
                      </div>
                      <div>
                        <span class="fw-bold me-2">₹{{ "%.2f"|format(item_total) }}</span>
                        <a href="{{ url_for('remove_from_cart_generic', item_type='course', item_id=item.id) }}" 
                           class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-trash"></i>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <!-- Mobile Book Card -->
            <div class="card mb-3 border-0 shadow-sm">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3">
                    {% if item.image %}
                      <img src="{{ url_for('static', filename='uploads/books/' ~ item.image) }}" 
                           alt="{{ item.title }}" 
                           class="img-fluid rounded"
                           style="height: 80px; object-fit: contain;">
                    {% else %}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                           style="height: 80px;">
                        <i class="bi bi-book text-muted"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-9">
                    <h6 class="mb-1 fw-semibold">{{ item.title }}</h6>
                    <p class="mb-1 text-muted small">by {{ item.author }}</p>
                    <div class="mb-2">
                      <span class="badge bg-primary me-1">{{ item.category }}</span>
                      <span class="badge bg-secondary">{{ item.subject }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <span class="fw-bold text-success">₹{{ "%.2f"|format(item.price) }}</span>
                        <span class="text-muted"> × {{ item.quantity }}</span>
                      </div>
                      <div>
                        <span class="fw-bold me-2">₹{{ "%.2f"|format(item_total) }}</span>
                        <a href="{{ url_for('remove_from_cart_generic', item_type='book', item_id=item.id) }}" 
                           class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-trash"></i>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        
        <!-- Mobile Total -->
        <div class="card border-0 shadow-sm bg-light">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold">Grand Total:</h5>
              <h4 class="mb-0 fw-bold text-success">₹{{ "%.2f"|format(grand_total.value) }}</h4>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="row mt-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
          <a href="{{ url_for('books') }}" class="btn btn-outline-primary btn-lg w-100">
            <i class="bi bi-arrow-left me-2"></i>Continue Shopping
          </a>
        </div>
        <div class="col-12 col-md-6">
          <a href="{{ url_for('checkout') }}" class="btn btn-success btn-lg w-100">
            <i class="bi bi-credit-card me-2"></i>Proceed to Checkout
          </a>
        </div>
      </div>

      {% else %}
        <!-- Empty Cart Message -->
        <div class="text-center py-5">
          <div class="mb-4">
            <i class="bi bi-cart-x" style="font-size: 4rem; color: #6c757d;"></i>
          </div>
          <h3 class="h4 text-muted mb-3">Your cart is empty</h3>
          <p class="text-muted mb-4">
            Discover amazing books and start building your collection!
          </p>
          <a href="{{ url_for('books') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-book me-2"></i>Browse Books
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}