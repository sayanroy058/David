{% extends 'base_new.html' %}
{% block title %}{{ book.title }} - Book Details{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4 py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('books') }}">Books</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ book.title }}</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- Book Images -->
        <div class="col-lg-5 col-xl-4 mb-4">
            <div class="position-sticky d-lg-block" style="top: 20px;">
                {% if book.images %}
                <!-- Main Image -->
                <div class="mb-3 position-relative">
                    <img id="mainImage"
                        src="{{ url_for('static', filename='uploads/books/' + book.images[0].image_filename) }}"
                        class="img-fluid rounded shadow-sm w-100" alt="{{ book.title }}"
                        style="height: 400px; object-fit: contain; background: #f8f9fa; cursor: zoom-in;"
                        onclick="openImageModal(this.src)">

                    <!-- Image counter badge -->
                    {% if book.images|length > 1 %}
                    <span class="position-absolute top-0 end-0 m-2 badge bg-dark bg-opacity-75 rounded-pill">
                        <span id="currentImageIndex">1</span> / {{ book.images|length }}
                    </span>
                    {% endif %}

                    <!-- Navigation arrows for multiple images -->
                    {% if book.images|length > 1 %}
                    <button
                        class="btn btn-dark btn-sm position-absolute top-50 start-0 translate-middle-y ms-2 opacity-75"
                        onclick="previousImage()" id="prevBtn" style="z-index: 10;">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button
                        class="btn btn-dark btn-sm position-absolute top-50 end-0 translate-middle-y me-2 opacity-75"
                        onclick="nextImage()" id="nextBtn" style="z-index: 10;">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    {% endif %}
                </div>

                <!-- Thumbnail Images -->
                {% if book.images|length > 1 %}
                <div class="d-flex gap-2 flex-wrap justify-content-center justify-lg-start" id="thumbnailContainer">
                    {% for image in book.images %}
                    <img src="{{ url_for('static', filename='uploads/books/' + image.image_filename) }}"
                        class="thumbnail-img border rounded cursor-pointer flex-shrink-0 {% if loop.index0 == 0 %}border-primary border-2{% endif %}"
                        alt="{{ book.title }}"
                        style="width: 70px; height: 70px; object-fit: contain; background: #f8f9fa;"
                        onclick="changeMainImage(this.src, {{ loop.index0 }})" data-index="{{ loop.index0 }}">
                    {% endfor %}
                </div>
                {% endif %}
                {% else %}
                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 400px;">
                    <div class="text-center">
                        <i class="bi bi-book text-muted" style="font-size: 4rem;"></i>
                        <p class="text-muted mt-2">No image available</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Book Details -->
        <div class="col-lg-7 col-xl-8">
            <div class="mb-4">
                <h1 class="h3 fw-bold text-dark mb-2 text-break">{{ book.title }}</h1>
                <p class="text-muted mb-3 fs-6">
                    <i class="bi bi-person me-1"></i>by <strong>{{ book.author }}</strong>
                </p>

                <!-- Rating Display -->
                {% if reviews %}
                <div class="d-flex align-items-center mb-3">
                    <div class="me-2">
                        {% for i in range(1, 6) %}
                        {% if i <= avg_rating %} <i class="bi bi-star-fill text-warning small"></i>
                            {% else %}
                            <i class="bi bi-star text-muted small"></i>
                            {% endif %}
                            {% endfor %}
                    </div>
                    <span class="text-muted small">{{ "%.1f"|format(avg_rating) }} ({{ reviews|length }} review{{ 's' if
                        reviews|length != 1 else '' }})</span>
                </div>
                {% endif %}

                <!-- Category and Subject -->
                <div class="mb-3">
                    {% if book.category %}
                    <span class="badge bg-primary me-2 small">{{ book.category }}</span>
                    {% endif %}
                    {% if book.subject %}
                    <span class="badge bg-secondary small">{{ book.subject }}</span>
                    {% endif %}
                </div>

                <!-- Price -->
                <div class="mb-4">
                    {% if book.original_price and book.original_price > book.price %}
                    <div class="mb-1">
                        <span class="text-muted text-decoration-line-through fs-6">₹{{
                            "%.2f"|format(book.original_price) }}</span>
                        {% set discount = ((book.original_price - book.price) / book.original_price) * 100 %}
                        <span class="badge bg-danger ms-2 small">{{ discount | round(0, 'floor') }}% OFF</span>
                    </div>
                    {% endif %}
                    <div class="fs-4 fw-bold text-success">₹{{ "%.2f"|format(book.price) }}</div>
                </div>

                <!-- Stock Status -->
                <div class="mb-4">
                    {% if book.quantity > 0 %}
                    {% if book.quantity < 5 %} <div class="alert alert-warning py-2 small">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Only {{ book.quantity }} left in stock!
                </div>
                {% else %}
                <div class="text-success small">
                    <i class="bi bi-check-circle me-1"></i>In Stock ({{ book.quantity }} available)
                </div>
                {% endif %}
                {% else %}
                <div class="alert alert-danger py-2 small">
                    <i class="bi bi-x-circle me-1"></i>Out of Stock
                </div>
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 d-sm-flex mb-4">
                {% if book.quantity > 0 %}
                <a href="{{ url_for('buy_now', book_id=book.id) }}" class="btn btn-success flex-sm-fill">
                    <i class="bi bi-cart-check me-2"></i>Buy Now
                </a>
                <a href="{{ url_for('add_to_cart', book_id=book.id) }}" class="btn btn-outline-primary flex-sm-fill">
                    <i class="bi bi-plus-circle me-2"></i>Add to Cart
                </a>
                {% else %}
                <button class="btn btn-secondary w-100" disabled>
                    <i class="bi bi-x-circle me-2"></i>Out of Stock
                </button>
                {% endif %}
            </div>

            <!-- Description -->
            {% if book.description %}
            <div class="mb-4">
                <h4 class="h6 fw-semibold mb-2">Description</h4>
                <div class="text-muted text-break small" style="line-height: 1.5; word-wrap: break-word;">
                    {{ book.description | safe }}
                </div>
            </div>
            {% endif %}

            <!-- Book Details Table -->
            <div class="mb-4">
                <h4 class="h6 fw-semibold mb-2">Book Details</h4>
                <div class="table-responsive">
                    <table class="table table-borderless table-sm">
                        <tbody>
                            <tr>
                                <td class="fw-medium text-muted small" style="width: 30%;">Author:</td>
                                <td class="small">{{ book.author }}</td>
                            </tr>
                            {% if book.category %}
                            <tr>
                                <td class="fw-medium text-muted small">Category:</td>
                                <td class="small">{{ book.category }}</td>
                            </tr>
                            {% endif %}
                            {% if book.subject %}
                            <tr>
                                <td class="fw-medium text-muted small">Subject:</td>
                                <td class="small">{{ book.subject }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td class="fw-medium text-muted small">Availability:</td>
                                <td class="small">
                                    {% if book.quantity > 0 %}
                                    <span class="text-success">In Stock</span>
                                    {% else %}
                                    <span class="text-danger">Out of Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h3 class="h5 mb-0">Customer Reviews</h3>
            </div>
            <div class="card-body px-3 px-md-4">

                <!-- Add Review Form (for purchased users) -->
                {% if user_can_review %}
                <div class="mb-4 p-3 bg-light rounded">
                    <h5 class="h6 mb-3">Write a Review</h5>
                    <form method="POST" action="{{ url_for('add_book_review', book_id=book.id) }}">
                        <div class="mb-3">
                            <label class="form-label fw-medium small">Rating</label>
                            <div class="d-flex flex-column flex-sm-row gap-2">
                                {% for i in range(5, 0, -1) %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rating" value="{{ i }}"
                                        id="rating{{ i }}" required>
                                    <label class="form-check-label small" for="rating{{ i }}">
                                        {% for j in range(i) %}★{% endfor %}{% for j in range(5-i) %}☆{% endfor %} {{ i
                                        }} Star{{ 's' if i != 1 else '' }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="review_text" class="form-label fw-medium small">Review (Optional)</label>
                            <textarea class="form-control" id="review_text" name="review_text" rows="3"
                                placeholder="Share your thoughts about this book..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-send me-2"></i>Submit Review
                        </button>
                    </form>
                </div>
                {% elif user_existing_review %}
                <div class="alert alert-info py-2 small">
                    <i class="bi bi-info-circle me-2"></i>You have already reviewed this book.
                </div>
                {% elif not user_purchased and 'user_id' in session %}
                <div class="alert alert-warning py-2 small">
                    <i class="bi bi-exclamation-triangle me-2"></i>You can only review books you have purchased.
                </div>
                {% elif 'user_id' not in session %}
                <div class="alert alert-info py-2 small">
                    <i class="bi bi-info-circle me-2"></i>Please <a href="{{ url_for('login') }}">login</a> to write a
                    review.
                </div>
                {% endif %}

                <!-- Display Reviews -->
                {% if reviews %}
                <div class="reviews-list">
                    {% for review in reviews %}
                    <div class="review-item border-bottom py-3 {% if not loop.last %}mb-3{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="fw-medium small">{{ review.user.email.split('@')[0] }}</div>
                                <div class="text-muted small">{{ review.created_at.strftime('%B %d, %Y') }}</div>
                            </div>
                            <div class="text-warning small">
                                {% for i in range(review.rating) %}★{% endfor %}{% for i in range(5-review.rating) %}☆{%
                                endfor %}
                            </div>
                        </div>
                        {% if review.review_text %}
                        <div class="text-muted small">{{ review.review_text }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-chat-square-text" style="font-size: 2.5rem;"></i>
                    <p class="mt-3 small">No reviews yet. Be the first to review this book!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Related Books -->
{% if related_books %}
<div class="row mt-5">
    <div class="col-12">
        <h3 class="h5 mb-3">Related Books</h3>
        <div class="row g-3">
            {% for related_book in related_books %}
            <div class="col-6 col-md-4 col-lg-3 col-xl-2">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="position-relative" style="height: 160px;">
                        <a href="{{ url_for('book_detail', book_id=related_book.id) }}">
                            {% if related_book.images %}
                            <img src="{{ url_for('static', filename='uploads/books/' + related_book.images[0].image_filename) }}"
                                class="card-img-top h-100 w-100" alt="{{ related_book.title }}"
                                style="object-fit: contain; background: #f8f9fa;">
                            {% else %}
                            <div class="h-100 bg-light d-flex align-items-center justify-content-center">
                                <i class="bi bi-book text-muted" style="font-size: 1.5rem;"></i>
                            </div>
                            {% endif %}
                        </a>
                    </div>
                    <div class="card-body p-2">
                        <h6 class="card-title small mb-1">
                            <a href="{{ url_for('book_detail', book_id=related_book.id) }}"
                                class="text-decoration-none text-dark text-break">
                                {{ related_book.title | truncate(35) }}
                            </a>
                        </h6>
                        <p class="text-muted small mb-1 text-break">{{ related_book.author | truncate(25) }}</p>
                        <div class="fw-bold text-success small">₹{{ "%.2f"|format(related_book.price) }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Bundle Offers -->
{% if bundle_offers %}
<div class="row mt-5">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <h3 class="h5 mb-0 me-3">Bundle Offers</h3>
            <small class="text-muted">Save more with book bundles</small>
        </div>
        <div class="row g-4">
            {% for bundle_data in bundle_offers %}
            {% set bundle = bundle_data.bundle %}
            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm bundle-card">
                    <div class="card-body p-4">
                        <!-- Bundle Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1">{{ bundle.title }}</h5>
                                {% if bundle.description %}
                                <p class="text-muted small mb-0">{{ bundle.description | truncate(80) }}</p>
                                {% endif %}
                            </div>
                            <span class="badge bg-success fs-6">
                                Save {{ "%.0f"|format(bundle_data.savings_percentage) }}%
                            </span>
                        </div>

                        <!-- Books Preview -->
                        <div class="mb-3">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <span class="small text-muted me-2">Includes:</span>
                                {% for book in bundle.books[:4] %}
                                <div class="d-flex align-items-center">
                                    {% if book.images %}
                                    <img src="{{ url_for('static', filename='uploads/books/' + book.images[0].image_filename) }}"
                                         alt="{{ book.title }}" class="rounded" style="width: 30px; height: 40px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                         style="width: 30px; height: 40px;">
                                        <i class="bi bi-book text-muted small"></i>
                                    </div>
                                    {% endif %}
                                    <span class="small ms-1 text-truncate" style="max-width: 100px;">{{ book.title }}</span>
                                </div>
                                {% endfor %}
                                {% if bundle.books|length > 4 %}
                                <span class="small text-muted">+{{ bundle.books|length - 4 }} more</span>
                                {% endif %}
                            </div>
                            <div class="small text-muted mt-1">
                                {{ bundle.books|length }} books total
                            </div>
                        </div>

                        <!-- Pricing Display -->
                        <div class="pricing-section p-3 bg-light rounded mb-3">
                            <div class="row align-items-center">
                                <div class="col-6">
                                    <div class="small text-muted">Bundle Price:</div>
                                    <div class="h5 text-success mb-0">₹{{ "%.2f"|format(bundle.selling_price) }}</div>
                                </div>
                                <div class="col-6 text-end">
                                    <div class="small text-muted">
                                        <span style="text-decoration: line-through;">₹{{ "%.2f"|format(bundle_data.total_mrp) }}</span>
                                    </div>
                                    <div class="text-success fw-bold">
                                        Save ₹{{ "%.2f"|format(bundle_data.savings_amount) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 d-md-flex">
                            <button class="btn btn-outline-primary btn-sm flex-fill" type="button" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#bundleModal{{ bundle.id }}">
                                <i class="bi bi-eye me-1"></i>View Bundle Details
                            </button>
                            <a href="{{ url_for('add_bundle_to_cart', bundle_id=bundle.id) }}" 
                               class="btn btn-success btn-sm flex-fill">
                                <i class="bi bi-cart-plus me-1"></i>Add Bundle to Cart
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
</div>

<style>
    .thumbnail-img {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .thumbnail-img:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .review-item:last-child {
        border-bottom: none !important;
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .position-sticky {
            position: static !important;
        }
    }

    @media (max-width: 575.98px) {
        .container-fluid {
            padding-left: 12px;
            padding-right: 12px;
        }

        .thumbnail-img {
            width: 45px !important;
            height: 45px !important;
        }

        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .fs-4 {
            font-size: 1.5rem !important;
        }

        .h3 {
            font-size: 1.4rem !important;
        }
    }

    /* Ensure images don't overflow */
    img {
        max-width: 100%;
        height: auto;
    }

    /* Better text wrapping */
    .text-break {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Improved spacing and typography */
    .card-body {
        line-height: 1.4;
    }

    .breadcrumb {
        font-size: 0.9rem;
    }

    .badge {
        font-size: 0.75rem;
    }

    /* Better button spacing */
    .btn {
        font-weight: 500;
    }

    /* Compact table styling */
    .table-sm td {
        padding: 0.4rem 0.5rem;
    }

    /* Bundle offers styling */
    .bundle-card {
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
    }

    .bundle-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: #007bff;
    }

    .bundle-card .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
    }

    .pricing-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
    }

    .bundle-card .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
    }

    .bundle-card .btn-success:hover {
        background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        transform: translateY(-1px);
    }

    .bundle-card .btn-outline-primary:hover {
        transform: translateY(-1px);
    }
    
    /* Bundle book item styles */
    .bundle-book-item {
        position: relative;
        margin-right: 15px;
        margin-bottom: 15px;
        width: 50px;
    }
    
    .bundle-book-preview {
        width: 50px;
        height: 70px;
        object-fit: cover;
        margin-right: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .bundle-books-preview {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    .bundle-book-title {
        display: block;
        font-size: 10px;
        color: #333;
        max-width: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-top: 2px;
    }
</style>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ book.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" alt="{{ book.title }}">
            </div>
        </div>
    </div>
</div>

<!-- Bundle Modals -->
{% for bundle_data in bundle_offers %}
{% set bundle = bundle_data.bundle %}
<div class="modal fade" id="bundleModal{{ bundle.id }}" tabindex="-1" aria-labelledby="bundleModalLabel{{ bundle.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bundleModalLabel{{ bundle.id }}">{{ bundle.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12 mb-4">
            <h6>Bundle Description</h6>
            <p>{{ bundle.description }}</p>
          </div>
          <div class="col-md-12 mb-4">
            <h6>Books Included</h6>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Book</th>
                    <th>Author</th>
                    <th>Individual Price</th>
                  </tr>
                </thead>
                <tbody>
                  {% for book in bundle.books %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        {% if book.image %}
                        <img src="{{ url_for('static', filename='uploads/books/' ~ book.image) }}" alt="{{ book.title }}" class="me-2" style="width: 40px; height: 55px; object-fit: cover;">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 55px;">
                          <i class="bi bi-book text-muted small"></i>
                        </div>
                        {% endif %}
                        <span>{{ book.title }}</span>
                      </div>
                    </td>
                    <td>{{ book.author }}</td>
                    <td>₹{{ book.price }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="2" class="text-end"><strong>Total MRP:</strong></td>
                    <td>₹{{ bundle_data.total_mrp }}</td>
                  </tr>
                  <tr>
                    <td colspan="2" class="text-end"><strong>Bundle Price:</strong></td>
                    <td>₹{{ bundle.selling_price }}</td>
                  </tr>
                  <tr class="table-success">
                    <td colspan="2" class="text-end"><strong>You Save:</strong></td>
                    <td>₹{{ "%.2f"|format(bundle_data.savings_amount) }} ({{ "%.2f"|format(bundle_data.savings_percentage) }}%)</td>
                  </tr>                  
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="{{ url_for('add_bundle_to_cart', bundle_id=bundle.id) }}" class="btn btn-primary">Add Bundle to Cart</a>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script>
    let currentImageIndex = 0;
    const bookImages = [
        {% for image in book.images %}
    "{{ url_for('static', filename='uploads/books/' ~ image.image_filename) }}"{% if not loop.last %}, {% endif %}
    {% endfor %}
];

    function changeMainImage(src, index) {
        document.getElementById('mainImage').src = src;
        currentImageIndex = index;

        // Update image counter
        const counter = document.getElementById('currentImageIndex');
        if (counter) {
            counter.textContent = index + 1;
        }

        // Update thumbnail active state
        const thumbnails = document.querySelectorAll('.thumbnail-img');
        thumbnails.forEach(function(thumb, i) {
            if (i === index) {
                thumb.classList.add('border-primary', 'border-2');
                thumb.classList.remove('border-1');
            } else {
                thumb.classList.remove('border-primary', 'border-2');
                thumb.classList.add('border-1');
            }
        });
    }

    function previousImage() {
        if (bookImages.length > 1) {
            currentImageIndex = (currentImageIndex - 1 + bookImages.length) % bookImages.length;
            changeMainImage(bookImages[currentImageIndex], currentImageIndex);
        }
    }

    function nextImage() {
        if (bookImages.length > 1) {
            currentImageIndex = (currentImageIndex + 1) % bookImages.length;
            changeMainImage(bookImages[currentImageIndex], currentImageIndex);
        }
    }

    function openImageModal(src) {
        document.getElementById('modalImage').src = src;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
        if (e.key === 'ArrowLeft') {
            previousImage();
        } else if (e.key === 'ArrowRight') {
            nextImage();
        }
    });

    // Touch/swipe support for mobile
    let touchStartX = 0;
    let touchEndX = 0;

    const mainImageElement = document.getElementById('mainImage');
    if (mainImageElement) {
        mainImageElement.addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        mainImageElement.addEventListener('touchend', function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
    }

    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                nextImage(); // Swipe left - next image
            } else {
                previousImage(); // Swipe right - previous image
            }
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Set first thumbnail as active by default
        const firstThumbnail = document.querySelector('.thumbnail-img');
        if (firstThumbnail) {
            firstThumbnail.classList.add('border-primary', 'border-2');
        }
    });
</script>
<style>
/* --------- Floating Button ---------- */
.shadow-floating-chat {
  position: fixed; bottom: 20px; right: 20px;
  box-shadow: 0 4px 18px rgba(13,110,253,0.25);
  width: 54px; height: 54px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem;
  border-radius: 50%;
  background: #0d6efd;
  color: #fff;
  cursor: pointer;
  transition: box-shadow 0.25s, transform 0.1s;
  z-index: 1050;
}
.shadow-floating-chat:hover {
  transform: scale(1.08);
  box-shadow: 0 8px 24px rgba(13,110,253,0.35);
}

/* --------- Chatbot Box ---------- */
.chatbot-box {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 300px;   /* default (tablet) */
  height: 380px;  /* default (tablet) */
  max-width: 95vw;
  max-height: 80vh;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform: translateY(30px);
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  z-index: 1060;
}
.chatbot-box.show {
  transform: translateY(0);
  opacity: 1;
  pointer-events: auto;
}

/* --------- Chat Header ---------- */
.chatbot-header {
  background: #0d6efd;
  color: #fff;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.chatbot-header img {
  border-radius: 50%;
  margin-right: 6px;
}

/* --------- Chat Body ---------- */
.chatbot-body {
  flex: 1;
  padding: 8px;
  overflow-y: auto;
  background: #f8f9fa;
}

/* --------- Messages ---------- */
.msg-bubble {
  max-width: 75%;
  border-radius: 15px;
  padding: 8px 12px;
  font-size: 0.95rem;
  margin-bottom: 6px;
  animation: bubbleSlideIn 0.25s ease;
}
.chat-message { display: flex; margin-bottom: 6px; }
.user-msg { justify-content: flex-end; }
.bot-msg { justify-content: flex-start; }
.user-msg .msg-bubble {
  background: linear-gradient(135deg, #0d6efd 90%, #3db0ef 100%);
  color: #fff;
  border-bottom-right-radius: 0;
}
.bot-msg .msg-bubble {
  background: #fff;
  border: 1px solid #dee2e6;
  color: #212529;
  border-bottom-left-radius: 0;
}

/* --------- Input Area ---------- */
.chatbot-footer {
  padding: 6px;
  border-top: 1px solid #dee2e6;
  display: flex;
  gap: 6px;
}
#userInput {
  flex: 1;
  border-radius: 10px;
  border: 1px solid #dee2e6;
  padding: 5px 8px;
  font-size: 0.9rem;
}
#userInput:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 2px rgba(13,110,253,0.1);
}
.send-btn {
  background: #0d6efd;
  border: none;
  color: #fff;
  padding: 5px 10px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}
.send-btn:hover { background: #0b5ed7; }

/* --------- Responsive ---------- */
/* Desktop (large) */
@media (min-width: 992px) {
  .chatbot-box {
    width: 340px;
    height: 420px;
  }
}

/* Mobile (small) */
@media (max-width: 480px) {
  .chatbot-box {
    right: 10px;
    bottom: 70px;
    width: 90vw;
    height: 70vh;
  }
}
</style>


<!-- Floating Chat Button -->
<div class="shadow-floating-chat" id="chatToggle">💬</div>

<!-- Chatbot Box -->
<div class="chatbot-box" id="chatBox">
  <div class="chatbot-header">
    <div class="d-flex align-items-center">
      <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp" width="28" alt="Bot">
      <strong>Easy2learning Chatbot</strong>
    </div>
    <button class="btn-close btn-close-white" id="chatClose"></button>
  </div>
  <div class="chatbot-body" id="chatBody">
    <div class="bot-msg chat-message">
      <div class="msg-bubble">
        Hi! Welcome to Easy2learning — your trusted destination for engineering and competitive exam coaching.<br>
        📞 +91 85848 64783<br>
        Type <b>courses</b> to see our course list.
      </div>
    </div>
  </div>
  <div class="chatbot-footer">
    <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off">
    <button class="send-btn" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const chatToggle = document.getElementById("chatToggle");
const chatBox = document.getElementById("chatBox");
const chatClose = document.getElementById("chatClose");
const chatBody = document.getElementById("chatBody");
const userInput = document.getElementById("userInput");

chatToggle.addEventListener("click", () => {
  chatBox.classList.toggle("show");
});
chatClose.addEventListener("click", () => {
  chatBox.classList.remove("show");
});

const botReplies = [
  {
    triggers: ['hi', 'hello', 'hey', 'good morning', 'good evening'],
    reply: `Hi!<br>Welcome to Easy2learning — your trusted destination for engineering and competitive exam coaching.<br>
    📞 Contact us: +91 85848 64783<br>
    Feel free to reach out with any questions.<br>
    If you’d like to know about our courses, just type <b>courses</b>.`
  },
  {
    triggers: ['courses', 'course list', 'show me your courses', 'what courses do you offer'],
    reply: `We offer the following courses at Easy2learning:<br><br>
    <b>Foundation Courses:</b><br>• All Diploma Courses (Semester-wise)<br>• B.Tech Courses (Semester-wise)<br><br>
    <b>Certificate Courses:</b><br>• AutoCAD<br>• Solar Internship<br>• Software Courses<br><br>
    <b>Competitive Exams Preparation:</b><br>• JEE (Main & Advanced)<br>• SSC-JE<br>• RRB-JE<br>• WBSEDCL<br>• WBSETCL<br>• WBPSC-JE<br>• WBJEE & Other State Engineering Entrance Exams<br><br>
    Want to know more about any specific course? Just type the course name (e.g., JEE, AutoCAD, WBJEE, etc.)<br><br>
    📲 Download Our Apps:<br>
    • <a href="https://play.google.com/store/apps/details?id=com.easy2learning2.appx" target="_blank">Diploma Students App</a><br>
    • <a href="https://play.google.com/store/apps/details?id=co.edvin.ubglj" target="_blank">B-Tech & JELET App</a>`
  },
  {
    triggers: ['jee', 'jee main', 'jee advanced'],
    reply: `Our <b>JEE (Main & Advanced)</b> program is designed for serious aspirants aiming for top engineering colleges.<br><br>
    • Faculty from IITs & NITs<br>
    • Mock Tests & Performance Analysis<br>
    • One-on-one doubt sessions<br>
    • Study material with PYQs<br>
    • Personalised attention & strategic mentoring<br><br>
    📞 Call us for more info: +91 85848 64783`
  },
  {
    triggers: ['diploma', 'diploma courses'],
    reply: `We offer semester-wise coaching for all Diploma engineering subjects.<br><br>
    • Conceptual clarity & exam-focused teaching<br>
    • One-on-one doubt clearing<br>
    • Weekly assessments & progress tracking<br><br>
    📲 <a href="https://play.google.com/store/apps/details?id=com.easy2learning2.appx" target="_blank">Want to know more about the course? Click here</a>`
  },
  {
    triggers: ['btech', 'b.tech', 'btech course'],
    reply: `Our <b>B.Tech</b> semester-wise coaching helps students with university and competitive exam preparation.<br><br>
    • Topic-wise lectures<br>
    • Smart classroom support<br>
    • Study materials & assignments<br><br>
    📲 <a href="https://play.google.com/store/apps/details?id=co.edvin.ubglj" target="_blank">Want to know more about the course? Click here</a>`
  },
  {
    triggers: ['autocad'],
    reply: `Our <b>AutoCAD</b> certificate course includes:<br><br>
    • Hands-on practical training<br>
    • Real-time projects<br>
    • Certificate upon completion<br>
    • Expert instructors<br><br>
    📞 Call us to enroll: +91 85848 64783`
  },
  {
    triggers: ['wbjee', 'state entrance'],
    reply: `Get ready for <b>WBJEE & other State Engineering Entrance Exams</b> with our expert-designed program.<br><br>
    • Subject-wise coaching<br>
    • Exam-focused strategies<br>
    • Mock tests & practice sessions<br>
    • Doubt-clearing support<br><br>
    📞 Contact us for guidance: +91 85848 64783`
  },
  {
    triggers: ['ssc-je', 'rrb-je', 'wbsedcl', 'wbpsc-je', 'wbsetcl'],
    reply: `We provide dedicated coaching for technical government exams like <b>SSC-JE, RRB-JE, WBSEDCL, WBSETCL, and WBPSC-JE</b>.<br><br>
    • Syllabus-wise structured classes<br>
    • Previous year questions<br>
    • Technical concept clearing<br>
    • Mock tests & assignments<br><br>
    📞 Call us to join: +91 85848 64783`
  },
  {
    triggers: ['about', 'about you', 'about easy2learning', 'who are you'],
    reply: `Easy2learning is a premier coaching institute for engineering and competitive exams.<br><br>
    We help students achieve top results through:<br>
    • Academic excellence<br>
    • Expert faculty from IITs, NITs & PhDs<br>
    • One-on-one doubt sessions<br>
    • Mock tests & personalised mentoring<br>
    • Scholarships & affordable fees<br><br>
    📞 Phone: +91 85848 64783<br>
    📧 Email: contact@easy2learning.in<br>
    📍 Address: 19D, Bhagabati Chatterjee St, Belghariya, Kolkata`
  },
  {
    triggers: ['i want to join a course', 'classes', 'class info', 'can you tell me about your classes', 'i want to know about your courses'],
    reply: `We offer a wide range of programs including Diploma & B.Tech coaching, competitive exam prep (like JEE, SSC-JE), and certificate courses (AutoCAD, Solar Internship, etc.)<br><br>
    📲 Download our apps:<br>
    • <a href="https://play.google.com/store/apps/details?id=com.easy2learning2.appx" target="_blank">Diploma App</a><br>
    • <a href="https://play.google.com/store/apps/details?id=co.edvin.ubglj" target="_blank">B-Tech & JELET App</a><br><br>
    🌐 Explore full course info: <a href="#" target="_blank">Visit Website</a><br><br>
    Need info on a specific course? Just type the course name!`
  }
];

function sendMessage() {
  const userText = userInput.value.trim();
  if (!userText) return;

  const userMsg = document.createElement("div");
  userMsg.classList.add("chat-message","user-msg");
  userMsg.innerHTML = `<div class="msg-bubble">${userText}</div>`;
  chatBody.appendChild(userMsg);
  userInput.value = "";
  chatBody.scrollTop = chatBody.scrollHeight;

  const lowerText = userText.toLowerCase();
  const matchedReply = botReplies.find(item =>
    item.triggers.some(trigger => lowerText.includes(trigger))
  )?.reply;

  const botMsg = document.createElement("div");
  botMsg.classList.add("chat-message","bot-msg");
  botMsg.innerHTML = `<div class="msg-bubble">...</div>`;
  chatBody.appendChild(botMsg);
  chatBody.scrollTop = chatBody.scrollHeight;

  setTimeout(() => {
    botMsg.innerHTML = `<div class="msg-bubble">${matchedReply || "Sorry, I didn’t catch that. Try <b>courses</b> or <b>about</b>."}</div>`;
    chatBody.scrollTop = chatBody.scrollHeight;
  }, 700);
}

userInput.addEventListener("keypress", function(e) {
  if (e.key === "Enter") sendMessage();
});
</script>




<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
